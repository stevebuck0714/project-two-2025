<%- include('partials/header') %>
<%- include('partials/secondary-nav') %>

<style>
/* Alert Card Compact Layout - Single Line Header */
.alert-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
}

.client-name {
    font-weight: 600;
    color: #212529;
    flex: 0 1 auto;
}

.alert-time {
    font-size: 0.85rem;
    color: #000;
    font-weight: 600;
    white-space: nowrap;
    margin-right: auto;
    margin-left: 0.5rem;
}

.alert-checkbox {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    font-size: 0.9rem;
    color: #495057;
    user-select: none;
    white-space: nowrap;
    margin-left: auto;
}

.alert-checkbox input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
    border: 2px solid #000;
    border-radius: 0;
    appearance: none;
    -webkit-appearance: none;
    background-color: white;
    position: relative;
    flex-shrink: 0;
    display: inline-block;
}

.alert-checkbox input[type="checkbox"]:checked {
    background-color: white !important;
    border-color: #000 !important;
}

.alert-checkbox input[type="checkbox"]:checked::after {
    content: '‚úì' !important;
    position: absolute !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    color: black !important;
    font-size: 18px !important;
    font-weight: bold !important;
    line-height: 1 !important;
    display: block !important;
}

.alert-checkbox span {
    font-weight: 500;
}

/* Completed state styling */
.alert-card.completed {
    opacity: 0.6;
    background: #f8f9fa;
}

.alert-card.completed .alert-content {
    text-decoration: line-through;
}

.alert-card.completed .client-name {
    color: #28a745;
}

/* Make alert content more compact */
.alert-content p {
    margin: 0.25rem 0 0 0;
    line-height: 1.4;
}

.alert-content strong {
    display: block;
    margin-bottom: 0.25rem;
}
</style>

<div class="stability-message">
    <h2>Client Alerts & Communications</h2>
</div>

<div class="main-container">
    <div class="alerts-dashboard">
        <!-- Portfolio Alerts Section -->
        <div class="alerts-section">
            <h3 class="section-title">
                <span class="alert-icon">‚ö†Ô∏è</span>
                Portfolio Alerts
            </h3>
            <div class="alert-cards">
                <div class="alert-card high-priority" data-alert-id="alert-john-smith-risk">
                    <div class="alert-header">
                        <span class="client-name">John Smith - London, UK</span>
                        <span class="alert-time">2 hours ago</span>
                        <label class="alert-checkbox">
                            <span>Mark Resolved</span>
                            <input type="checkbox">
                        </label>
                    </div>
                    <div class="alert-content">
                        <strong>Portfolio Risk Exposure</strong>
                        <p>Portfolio concentration in tech sector exceeds 40% threshold. Recommend diversification review.</p>
                    </div>
                </div>

                <div class="alert-card medium-priority" data-alert-id="alert-marie-dubois-volatility">
                    <div class="alert-header">
                        <span class="client-name">Marie Dubois - Paris, France</span>
                        <span class="alert-time">5 hours ago</span>
                        <label class="alert-checkbox">
                            <span>Mark Resolved</span>
                            <input type="checkbox">
                        </label>
                    </div>
                    <div class="alert-content">
                        <strong>Market Volatility Impact</strong>
                        <p>Portfolio value down 3.2% due to European market volatility. Client may require reassurance call.</p>
                    </div>
                </div>

                <div class="alert-card low-priority" data-alert-id="alert-hans-weber-rebalancing">
                    <div class="alert-header">
                        <span class="client-name">Hans Weber - Munich, Germany</span>
                        <span class="alert-time">1 day ago</span>
                        <label class="alert-checkbox">
                            <span>Mark Resolved</span>
                            <input type="checkbox">
                        </label>
                    </div>
                    <div class="alert-content">
                        <strong>Rebalancing Opportunity</strong>
                        <p>Portfolio drift detected. Automatic rebalancing available or manual review recommended.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Communications Section -->
        <div class="communications-section">
            <h3 class="section-title">
                <span class="comm-icon">üí¨</span>
                Recent Client Communications
            </h3>
            
            <!-- Portfolio Builder Messages -->
            <div class="comm-category">
                <h4 class="category-title">Portfolio Builder Inquiries</h4>
                <div class="comm-cards">
                    <div class="comm-card">
                        <div class="comm-header">
                            <span class="client-name">Sofia Rossi - Milan, Italy</span>
                            <span class="comm-time">Yesterday, 2:30 PM</span>
                        </div>
                        <div class="comm-content">
                            <strong>ESG Investment Options</strong>
                            <p>"I'm interested in adding more sustainable investments to my portfolio. Can we schedule a call to discuss ESG options?"</p>
                            <div class="comm-actions">
                                <button class="btn-small respond">Respond</button>
                                <button class="btn-small schedule">Schedule Call</button>
                            </div>
                        </div>
                    </div>

                    <div class="comm-card">
                        <div class="comm-header">
                            <span class="client-name">Carlos Garcia - Madrid, Spain</span>
                            <span class="comm-time">2 days ago, 4:15 PM</span>
                        </div>
                        <div class="comm-content">
                            <strong>Risk Tolerance Review</strong>
                            <p>"Given recent market conditions, I'd like to review my risk tolerance and possibly adjust my allocation strategy."</p>
                            <div class="comm-actions">
                                <button class="btn-small respond">Respond</button>
                                <button class="btn-small schedule">Schedule Call</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bulletin Board Messages -->
            <div class="comm-category">
                <h4 class="category-title">Bulletin Board Updates</h4>
                <div class="comm-cards">
                    <div class="comm-card">
                        <div class="comm-header">
                            <span class="client-name">Anna Kowalski - Warsaw, Poland</span>
                            <span class="comm-time">3 days ago, 10:20 AM</span>
                        </div>
                        <div class="comm-content">
                            <strong>Private Equity Position - Looking to Sell</strong>
                            <p>"I'm interested in listing my Carlyle Europe Partners V position for sale on the secondary market. Can you help facilitate this and provide guidance?"</p>
                            <div class="comm-actions">
                                <button class="btn-small respond">Respond</button>
                                <button class="btn-small publish">List Position</button>
                            </div>
                        </div>
                    </div>

                    <div class="comm-card">
                        <div class="comm-header">
                            <span class="client-name">Erik Andersson - Stockholm, Sweden</span>
                            <span class="comm-time">1 week ago, 3:45 PM</span>
                        </div>
                        <div class="comm-content">
                            <strong>Available PE Investment Interest</strong>
                            <p>"I saw the KKR North America Fund XIII opportunity posted on the bulletin board. Could we schedule a call to discuss the investment terms and my potential allocation?"</p>
                            <div class="comm-actions">
                                <button class="btn-small respond">Respond</button>
                                <button class="btn-small schedule">Schedule Call</button>
                            </div>
                        </div>
                    </div>

                    <div class="comm-card">
                        <div class="comm-header">
                            <span class="client-name">Marco Silva - Lisbon, Portugal</span>
                            <span class="comm-time">5 days ago, 2:15 PM</span>
                        </div>
                        <div class="comm-content">
                            <strong>Secondary Market Inquiry</strong>
                            <p>"I'm considering divesting my Apollo Global Management IX position before the final capital calls. What's the current secondary market sentiment for this vintage?"</p>
                            <div class="comm-actions">
                                <button class="btn-small respond">Respond</button>
                                <button class="btn-small evaluate">Market Analysis</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Statistics -->
        <div class="summary-section">
            <h3 class="section-title">
                <span class="stats-icon">üìä</span>
                Today's Summary
            </h3>
            <div class="summary-stats">
                <div class="stat-card">
                    <div class="stat-number">7</div>
                    <div class="stat-label">Active Alerts</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">12</div>
                    <div class="stat-label">Pending Responses</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">3</div>
                    <div class="stat-label">Calls Scheduled</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">85%</div>
                    <div class="stat-label">Client Satisfaction</div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.alerts-dashboard {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.section-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.alerts-section, .communications-section, .summary-section {
    background: white;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

/* Alert Cards */
.alert-cards {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.alert-card {
    border-left: 4px solid #3498db;
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    transition: transform 0.2s ease;
}

.alert-card:hover {
    transform: translateX(5px);
}

.alert-card.high-priority {
    border-left-color: #e74c3c;
    background: #fdf2f2;
}

.alert-card.medium-priority {
    border-left-color: #f39c12;
    background: #fefbf2;
}

.alert-card.low-priority {
    border-left-color: #27ae60;
    background: #f2fdf5;
}

.alert-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.client-name {
    font-weight: 600;
    color: #2c3e50;
}

.alert-level {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
}

.alert-level.high {
    background: #e74c3c;
    color: white;
}

.alert-level.medium {
    background: #f39c12;
    color: white;
}

.alert-level.low {
    background: #27ae60;
    color: white;
}

.alert-content strong {
    color: #2c3e50;
    font-size: 1.1rem;
}

.alert-content p {
    margin: 8px 0;
    color: #5d6d7e;
    line-height: 1.5;
}

.alert-time {
    font-size: 0.9rem;
    color: #95a5a6;
    font-style: italic;
}

/* Communication Cards */
.comm-category {
    margin-bottom: 30px;
}

.category-title {
    font-size: 1.2rem;
    font-weight: 500;
    color: #34495e;
    margin-bottom: 15px;
    padding-bottom: 8px;
    border-bottom: 2px solid #ecf0f1;
}

.comm-cards {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.comm-card {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 20px;
    transition: box-shadow 0.2s ease;
}

.comm-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.comm-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.comm-time {
    font-size: 0.9rem;
    color: #7f8c8d;
}

.comm-content strong {
    color: #2c3e50;
    font-size: 1.05rem;
}

.comm-content p {
    margin: 10px 0;
    color: #5d6d7e;
    line-height: 1.5;
    font-style: italic;
}

.comm-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.btn-small {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.btn-small.respond {
    background: #3498db;
    color: white;
}

.btn-small.respond:hover {
    background: #2980b9;
}

.btn-small.schedule, .btn-small.publish {
    background: #27ae60;
    color: white;
}

.btn-small.schedule:hover, .btn-small.publish:hover {
    background: #229954;
}

.btn-small.evaluate {
    background: #8e44ad;
    color: white;
}

.btn-small.evaluate:hover {
    background: #7d3c98;
}

/* Summary Statistics */
.summary-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 25px;
    border-radius: 12px;
    text-align: center;
    transition: transform 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-number {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 8px;
}

.stat-label {
    font-size: 0.95rem;
    opacity: 0.9;
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* Responsive Design */
@media (max-width: 768px) {
    .alerts-dashboard {
        padding: 10px;
    }
    
    .alert-header, .comm-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
    }
    
    .comm-actions {
        flex-wrap: wrap;
    }
    
    .summary-stats {
        grid-template-columns: repeat(2, 1fr);
    }
}
</style>

<script>
// Add interactive functionality
document.addEventListener('DOMContentLoaded', function() {
    // Load resolved alerts from server
    loadResolvedAlerts();
    
    // Add change handlers for checkboxes
    document.querySelectorAll('.alert-checkbox input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const alertCard = this.closest('.alert-card');
            const alertId = alertCard.getAttribute('data-alert-id');
            const isResolved = this.checked;
            
            // Toggle completed state
            if (isResolved) {
                alertCard.classList.add('completed');
            } else {
                alertCard.classList.remove('completed');
            }
            
            // Save to server
            saveResolvedAlert(alertId, isResolved);
        });
    });
    
    // Add click handlers for action buttons
    document.querySelectorAll('.btn-small').forEach(button => {
        button.addEventListener('click', function() {
            const action = this.textContent.trim();
            const clientName = this.closest('.comm-card').querySelector('.client-name').textContent;
            
            // Simple feedback for demo purposes
            this.style.background = '#2ecc71';
            this.textContent = '‚úì ' + action;
            
            setTimeout(() => {
                this.style.background = '';
                this.textContent = action;
            }, 2000);
            
            console.log(`${action} initiated for ${clientName}`);
        });
    });
    
    // Auto-refresh functionality (for demo)
    setInterval(() => {
        const timeElements = document.querySelectorAll('.alert-time, .comm-time');
        // In a real application, this would update with fresh data
        console.log('Checking for new alerts and communications...');
    }, 30000); // Check every 30 seconds
});

// Load resolved alerts from server
async function loadResolvedAlerts() {
    try {
        const response = await fetch('/api/get-resolved-alerts');
        const data = await response.json();
        
        if (data.success) {
            const resolvedAlerts = data.resolvedAlerts;
            
            // Apply resolved state to alert cards
            Object.keys(resolvedAlerts).forEach(alertId => {
                const alertCard = document.querySelector(`[data-alert-id="${alertId}"]`);
                if (alertCard) {
                    const checkbox = alertCard.querySelector('input[type="checkbox"]');
                    if (checkbox) {
                        checkbox.checked = true;
                        alertCard.classList.add('completed');
                    }
                }
            });
            
            console.log('Loaded resolved alerts:', Object.keys(resolvedAlerts));
        }
    } catch (error) {
        console.error('Error loading resolved alerts:', error);
    }
}

// Save resolved alert to server
async function saveResolvedAlert(alertId, resolved) {
    try {
        const response = await fetch('/api/save-resolved-alert', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ alertId, resolved })
        });
        
        const data = await response.json();
        
        if (data.success) {
            console.log('Saved alert resolution:', alertId, resolved);
        } else {
            console.error('Failed to save alert resolution:', data.message);
        }
    } catch (error) {
        console.error('Error saving alert resolution:', error);
    }
}
</script>

<%- include('partials/footer') %>
