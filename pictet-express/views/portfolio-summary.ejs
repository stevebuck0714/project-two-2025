<%- include('partials/header') %>
<%- include('partials/secondary-nav') %>

<div class="stability-message">
    <h2 id="portfolio-page-title">Portfolio Summary</h2>
</div>

<!-- Add Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="main-container">
    <div class="portfolio-summary-header">
        <div class="portfolio-date" id="portfolio-date"></div>
    </div>

    <!-- Portfolio Summary Tabs - Moved to sub-header navigation -->
    <div class="portfolio-tabs" style="display: none;">
        <button class="portfolio-tab active" onclick="showPortfolioTab('summary')">Portfolio Summary</button>
        <button class="portfolio-tab" onclick="showPortfolioTab('temporary')">Client Mandates</button>
        <button class="portfolio-tab" onclick="showPortfolioTab('pe-investments')">Available PE Investments</button>
    </div>

    <!-- Portfolio Summary Tab Content -->
    <div id="portfolio-summary-content" class="portfolio-tab-content active">
        <!-- Portfolio Overview Cards -->
        <div class="metrics-container">
        <div class="metric-item">
            <div class="metric-label">Total Portfolio Value</div>
            <div class="metric-value"><%= typeof formatNumber === 'function' ? formatNumber(processedData.metrics.totalValue) : processedData.metrics.totalValue.toLocaleString('de-DE', { style: 'currency', currency: 'EUR' }).replace('EUR', '€') %></div>
        </div>
        <div class="metric-item">
            <div class="metric-label">Total Investments</div>
            <div class="metric-value"><%= processedData.metrics.totalInvestments %></div>
        </div>
        <div class="metric-item">
            <div class="metric-label">Average Investment Size</div>
            <div class="metric-value"><%= typeof formatNumber === 'function' ? formatNumber(processedData.metrics.averageInvestmentSize) : processedData.metrics.averageInvestmentSize.toLocaleString('de-DE', { style: 'currency', currency: 'EUR' }).replace('EUR', '€') %></div>
        </div>
    </div>

    <!-- Asset Allocation Charts -->
    <div class="charts-container">
        <div class="chart-section">
            <h2>Asset Allocation</h2>
            <div class="chart-wrapper">
                <canvas id="assetAllocationChart"></canvas>
            </div>
        </div>
        <div class="chart-section">
            <h2>Geographic Distribution</h2>
            <div class="chart-wrapper">
                <canvas id="geographicAllocationChart"></canvas>
            </div>
        </div>
        <div class="chart-section">
            <h2>Portfolio Performance</h2>
            <div class="chart-wrapper">
                <canvas id="portfolioPerformanceChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Detailed Portfolio Tables -->
    <div class="portfolio-container">
        <div class="portfolio-section">
            <h2>Summary Portfolio Investments</h2>
            <div class="table-container">
                <table class="portfolio-table">
                    <thead>
                        <tr>
                            <th>Asset Type</th>
                            <th>Cost Basis</th>
                            <th>Total Value</th>
                            <th>Allocation %</th>
                            <th>Day Gain</th>
                            <th>Total Gain</th>
                            <th>Target Allocation</th>
                            <th>Deviation %</th>
                            <th>Deviation $</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% Object.entries(processedData.metrics.assetTypeBreakdown).forEach(([type, count]) => { %>
                            <tr data-asset-type="<%= type %>">
                                <td><%= type %></td>
                                <td><%= typeof formatNumber === 'function' ? formatNumber(processedData.metrics.assetAllocation[type] * processedData.metrics.totalValue / 100 * 0.85) : (processedData.metrics.assetAllocation[type] * processedData.metrics.totalValue / 100 * 0.85).toLocaleString('de-DE', { style: 'currency', currency: 'EUR' }).replace('EUR', '€') %></td>
                                <td><%= typeof formatNumber === 'function' ? formatNumber(processedData.metrics.assetAllocation[type] * processedData.metrics.totalValue / 100) : (processedData.metrics.assetAllocation[type] * processedData.metrics.totalValue / 100).toLocaleString('de-DE', { style: 'currency', currency: 'EUR' }).replace('EUR', '€') %></td>
                                <td class="current-allocation"><%= processedData.metrics.assetAllocation[type].toFixed(2) %>%</td>
                                <td class="positive">+€<%= Math.floor(Math.random() * 50000 + 10000).toLocaleString('de-DE') %></td>
                                <td class="positive">+€<%= Math.floor(processedData.metrics.assetAllocation[type] * processedData.metrics.totalValue / 100 * 0.15).toLocaleString('de-DE') %></td>
                                <td class="target-allocation-cell">
                                    <input type="number" 
                                           class="target-allocation-input" 
                                           min="0" 
                                           max="100" 
                                           step="0.01" 
                                           value="<%= processedData.metrics.assetAllocation[type].toFixed(2) %>"
                                           placeholder="0.00">%
                                </td>
                                <td class="deviation-cell">
                                    <span class="deviation-value">0.00%</span>
                                </td>
                                <td class="deviation-dollar-cell">
                                    <span class="deviation-dollar-value">€0</span>
                                </td>
                            </tr>
                        <% }); %>
                        <tr class="total-row">
                            <td><strong>TOTAL</strong></td>
                            <td><strong><%= typeof formatNumber === 'function' ? formatNumber(processedData.metrics.totalValue * 0.85) : (processedData.metrics.totalValue * 0.85).toLocaleString('de-DE', { style: 'currency', currency: 'EUR' }).replace('EUR', '€') %></strong></td>
                            <td><strong><%= typeof formatNumber === 'function' ? formatNumber(processedData.metrics.totalValue) : processedData.metrics.totalValue.toLocaleString('de-DE', { style: 'currency', currency: 'EUR' }).replace('EUR', '€') %></strong></td>
                            <td><strong>100.00%</strong></td>
                            <td class="positive"><strong>+€<%= Math.floor(processedData.metrics.totalValue * 0.05).toLocaleString('de-DE') %></strong></td>
                            <td class="positive"><strong>+€<%= Math.floor(processedData.metrics.totalValue * 0.15).toLocaleString('de-DE') %></strong></td>
                            <td class="target-total-cell"><strong><span id="target-total">100.00%</span></strong></td>
                            <td class="deviation-total-cell"><strong>-</strong></td>
                            <td class="deviation-dollar-total-cell"><strong>-</strong></td>
                        </tr>
                    </tbody>
                </table>
                <div class="target-allocation-controls">
                    <button id="save-targets" class="btn-primary">Save Target Allocations</button>
                    <button id="load-targets" class="btn-secondary">Load Saved Targets</button>
                    <button id="reset-targets" class="btn-outline">Reset to Current</button>
                    <button id="test-calc" class="btn-outline">Test Calculation</button>
                    <span id="save-status" class="save-status"></span>
                </div>
            </div>
        </div>

        <!-- Marketable Securities Section -->
        <div class="portfolio-section">
            <h2>Marketable Securities</h2>
            <div class="table-container">
                <table class="portfolio-table">
                    <thead>
                        <tr>
                            <th>Security Name</th>
                            <th>Symbol</th>
                            <th>Shares</th>
                            <th>Cost Basis</th>
                            <th>Current Price</th>
                            <th>Day Change</th>
                            <th>% Change</th>
                            <th>Market Value</th>
                            <th>Total Return</th>
                            <th>Return %</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% processedData.marketableSecurities.forEach(security => { %>
                            <tr>
                                <td><%= security.name %></td>
                                <td class="symbol-cell"><%= security.symbol %></td>
                                <td class="number-cell"><%= security.shares.toLocaleString() %></td>
                                <td class="currency-cell">$<%= security.basis.toFixed(2) %></td>
                                <td class="currency-cell">$<%= security.currentPrice.toFixed(2) %></td>
                                <td class="currency-cell <%= security.dayChange >= 0 ? 'positive' : 'negative' %>"><%= security.dayChange >= 0 ? '+' : '' %>$<%= security.dayChange.toFixed(2) %></td>
                                <td class="percentage-cell <%= security.dayChangePercent >= 0 ? 'positive' : 'negative' %>"><%= security.dayChangePercent >= 0 ? '+' : '' %><%= security.dayChangePercent.toFixed(2) %>%</td>
                                <td class="currency-cell">$<%= security.marketValue.toLocaleString() %></td>
                                <td class="currency-cell <%= security.totalReturn >= 0 ? 'positive' : 'negative' %>">$<%= security.totalReturn.toLocaleString() %></td>
                                <td class="percentage-cell <%= security.returnPercent >= 0 ? 'positive' : 'negative' %>"><%= security.returnPercent.toFixed(2) %>%</td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Combined Portfolio Table -->
        <div class="portfolio-section">
            <h2>Private Equity Investments</h2>
            <div class="table-container">
                <table class="portfolio-table">
                    <thead>
                        <tr>
                            <% if ((portfolio1.length > 0) || (portfolio2.length > 0)) { %>
                                <% const headers = portfolio1.length > 0 ? Object.keys(portfolio1[0]) : Object.keys(portfolio2[0]); %>
                                <% headers.forEach(header => { %>
                                    <th><%= header %></th>
                                <% }); %>
                            <% } %>
                        </tr>
                    </thead>
                    <tbody>
                        <% portfolio1.forEach(row => { %>
                            <tr>
                                <% Object.entries(row).forEach(([key, value]) => { %>
                                    <td>
                                        <% if (key === 'Fund Name') { %>
                                            <a href="/investment-details/<%= value.toLowerCase().replace(/\s+/g, '-') %>" class="fund-link">
                                                <%= value %>
                                            </a>
                                        <% } else if (typeof value === 'number') { %>
                                            <%= value.toLocaleString('de-DE', { style: 'currency', currency: 'EUR' }).replace('EUR', '€') %>
                                        <% } else { %>
                                            <%= value %>
                                        <% } %>
                                    </td>
                                <% }); %>
                            </tr>
                        <% }); %>
                        <% portfolio2.forEach(row => { %>
                            <tr>
                                <% Object.entries(row).forEach(([key, value]) => { %>
                                    <td>
                                        <% if (key === 'Fund Name') { %>
                                            <a href="/investment-details/<%= value.toLowerCase().replace(/\s+/g, '-') %>" class="fund-link">
                                                <%= value %>
                                            </a>
                                        <% } else if (typeof value === 'number') { %>
                                            <%= value.toLocaleString('de-DE', { style: 'currency', currency: 'EUR' }).replace('EUR', '€') %>
                                        <% } else { %>
                                            <%= value %>
                                        <% } %>
                                    </td>
                                <% }); %>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    </div>

    <!-- Client Mandates Tab Content -->
    <div id="temporary-content" class="portfolio-tab-content">
        <div class="strategy-columns">
            <!-- Private Equity Strategies Column -->
            <div class="strategy-column">
                <div class="strategy-category-container">
                    <h3 class="strategy-category-header">
                        <span class="ubs-text">LOMBARD ODIER</span> Private Equity Strategies
                    </h3>
                    <div class="strategy-list">
                        <div class="strategy-option" data-strategy="large-cap-buyout">
                            <div class="strategy-header">
                                <input type="checkbox" class="strategy-checkbox" id="large-cap-buyout">
                                <label class="strategy-name" for="large-cap-buyout">Large-Cap Buyout</label>
                            </div>
                            <div class="strategy-description text-muted">>€1B enterprise value</div>
                        </div>

                        <div class="strategy-option" data-strategy="mid-market-buyout">
                            <div class="strategy-header">
                                <input type="checkbox" class="strategy-checkbox" id="mid-market-buyout">
                                <label class="strategy-name" for="mid-market-buyout">Mid-Market Buyout</label>
                            </div>
                            <div class="strategy-description text-muted">€100M-€1B enterprise value</div>
                        </div>

                        <div class="strategy-option" data-strategy="small-cap-buyout">
                            <div class="strategy-header">
                                <input type="checkbox" class="strategy-checkbox" id="small-cap-buyout">
                                <label class="strategy-name" for="small-cap-buyout">Small-Cap Buyout</label>
                            </div>
                            <div class="strategy-description text-muted"><€100M enterprise value</div>
                        </div>

                        <div class="strategy-option" data-strategy="growth-equity">
                            <div class="strategy-header">
                                <input type="checkbox" class="strategy-checkbox" id="growth-equity">
                                <label class="strategy-name" for="growth-equity">Growth Equity</label>
                            </div>
                            <div class="strategy-description text-muted">Minority stakes in growth companies</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alternative Asset Strategies Column -->
            <div class="strategy-column">
                <div class="strategy-category-container">
                    <h3 class="strategy-category-header">
                        <span class="ubs-text">LOMBARD ODIER</span> Alternative Asset Strategies
                    </h3>
                    <div class="strategy-list">
                        <div class="strategy-option" data-strategy="real-estate-core">
                            <div class="strategy-header">
                                <input type="checkbox" class="strategy-checkbox" id="real-estate-core">
                                <label class="strategy-name" for="real-estate-core">Real Estate (Core)</label>
                            </div>
                            <div class="strategy-description text-muted">Stable, income-producing properties</div>
                        </div>

                        <div class="strategy-option" data-strategy="real-estate-opportunistic">
                            <div class="strategy-header">
                                <input type="checkbox" class="strategy-checkbox" id="real-estate-opportunistic">
                                <label class="strategy-name" for="real-estate-opportunistic">Real Estate (Opportunistic)</label>
                            </div>
                            <div class="strategy-description text-muted">Value-add and development</div>
                        </div>

                        <div class="strategy-option" data-strategy="infrastructure-core">
                            <div class="strategy-header">
                                <input type="checkbox" class="strategy-checkbox" id="infrastructure-core">
                                <label class="strategy-name" for="infrastructure-core">Infrastructure (Core)</label>
                            </div>
                            <div class="strategy-description text-muted">Stable, regulated infrastructure</div>
                        </div>

                        <div class="strategy-option" data-strategy="infrastructure-value-add">
                            <div class="strategy-header">
                                <input type="checkbox" class="strategy-checkbox" id="infrastructure-value-add">
                                <label class="strategy-name" for="infrastructure-value-add">Infrastructure (Value-Add)</label>
                            </div>
                            <div class="strategy-description text-muted">Emerging infrastructure sectors</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Other Alternatives Column -->
            <div class="strategy-column">
                <div class="strategy-category-container">
                    <h3 class="strategy-category-header">
                        <span class="ubs-text">LOMBARD ODIER</span> Other Alternatives
                    </h3>
                    <div class="strategy-list">
                        <div class="strategy-option" data-strategy="direct-lending">
                            <div class="strategy-header">
                                <input type="checkbox" class="strategy-checkbox" id="direct-lending">
                                <label class="strategy-name" for="direct-lending">Direct Lending</label>
                            </div>
                            <div class="strategy-description text-muted">Senior debt to mid-market companies</div>
                        </div>

                        <div class="strategy-option" data-strategy="mezzanine-finance">
                            <div class="strategy-header">
                                <input type="checkbox" class="strategy-checkbox" id="mezzanine-finance">
                                <label class="strategy-name" for="mezzanine-finance">Mezzanine Finance</label>
                            </div>
                            <div class="strategy-description text-muted">Hybrid debt-equity financing</div>
                        </div>

                        <div class="strategy-option" data-strategy="natural-resources">
                            <div class="strategy-header">
                                <input type="checkbox" class="strategy-checkbox" id="natural-resources">
                                <label class="strategy-name" for="natural-resources">Natural Resources</label>
                            </div>
                            <div class="strategy-description text-muted">Energy, mining, and commodities</div>
                        </div>

                        <div class="strategy-option" data-strategy="hedge-strategies">
                            <div class="strategy-header">
                                <input type="checkbox" class="strategy-checkbox" id="hedge-strategies">
                                <label class="strategy-name" for="hedge-strategies">Hedge Strategies</label>
                            </div>
                            <div class="strategy-description text-muted">Alternative hedge fund strategies</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="selection-counter text-muted mt-3">
            <small><span id="selected-count">0</span> selected | Recommended: 2-4</small>
        </div>

        <!-- ESG Framework Section -->
        <h2 class="strategy-category-header" style="text-align:center;margin-bottom:2rem;">ESG Framework</h2>
        <div class="strategy-columns">
            <!-- Environmental Criteria Column -->
            <div class="strategy-column">
                <div class="strategy-category-container">
                    <h3 class="strategy-category-header">
                        <span class="ubs-text">LOMBARD ODIER</span> Environmental Criteria
                    </h3>
                    <div class="strategy-list">
                        <div class="strategy-option">
                            <div class="strategy-header">
                                <label class="strategy-name">Climate Change Impact</label>
                            </div>
                            <div class="strategy-description text-muted">Assessment of company's initiatives to combat climate change</div>
                            <div class="score-input mt-2">
                                <select class="form-control">
                                    <option value="">Select Impact Score...</option>
                                    <option value="1">Low Impact</option>
                                    <option value="2">Moderate-Low Impact</option>
                                    <option value="3">Moderate Impact</option>
                                    <option value="4">Moderate-High Impact</option>
                                    <option value="5">High Impact</option>
                                </select>
                            </div>
                        </div>
                        <div class="strategy-option">
                            <div class="strategy-header">
                                <label class="strategy-name">Resource Efficiency</label>
                            </div>
                            <div class="strategy-description text-muted">Evaluation of resource management and conservation practices</div>
                            <div class="score-input mt-2">
                                <select class="form-control">
                                    <option value="">Select Efficiency Score...</option>
                                    <option value="1">Poor Efficiency</option>
                                    <option value="2">Fair Efficiency</option>
                                    <option value="3">Good Efficiency</option>
                                    <option value="4">Very Good Efficiency</option>
                                    <option value="5">Excellent Efficiency</option>
                                </select>
                            </div>
                        </div>
                        <div class="strategy-option">
                            <div class="strategy-header">
                                <label class="strategy-name">Environmental Innovation</label>
                            </div>
                            <div class="strategy-description text-muted">Investment in sustainable technologies and practices</div>
                            <div class="score-input mt-2">
                                <select class="form-control">
                                    <option value="">Select Innovation Score...</option>
                                    <option value="1">Minimal Innovation</option>
                                    <option value="2">Emerging Innovation</option>
                                    <option value="3">Moderate Innovation</option>
                                    <option value="4">Advanced Innovation</option>
                                    <option value="5">Leading Innovation</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Social Criteria Column -->
            <div class="strategy-column">
                <div class="strategy-category-container">
                    <h3 class="strategy-category-header">
                        <span class="ubs-text">LOMBARD ODIER</span> Social Criteria
                    </h3>
                    <div class="strategy-list">
                        <div class="strategy-option">
                            <div class="strategy-header">
                                <label class="strategy-name">Workforce Management</label>
                            </div>
                            <div class="strategy-description text-muted">Employee relations, diversity, and workplace safety</div>
                            <div class="score-input mt-2">
                                <select class="form-control">
                                    <option value="">Select Management Score...</option>
                                    <option value="1">Poor Management</option>
                                    <option value="2">Fair Management</option>
                                    <option value="3">Good Management</option>
                                    <option value="4">Very Good Management</option>
                                    <option value="5">Excellent Management</option>
                                </select>
                            </div>
                        </div>
                        <div class="strategy-option">
                            <div class="strategy-header">
                                <label class="strategy-name">Community Relations</label>
                            </div>
                            <div class="strategy-description text-muted">Impact on local communities and social initiatives</div>
                            <div class="score-input mt-2">
                                <select class="form-control">
                                    <option value="">Select Community Score...</option>
                                    <option value="1">Poor Engagement</option>
                                    <option value="2">Fair Engagement</option>
                                    <option value="3">Good Engagement</option>
                                    <option value="4">Very Good Engagement</option>
                                    <option value="5">Excellent Engagement</option>
                                </select>
                            </div>
                        </div>
                        <div class="strategy-option">
                            <div class="strategy-header">
                                <label class="strategy-name">Human Rights</label>
                            </div>
                            <div class="strategy-description text-muted">Human rights policies and implementation</div>
                            <div class="score-input mt-2">
                                <select class="form-control">
                                    <option value="">Select Rights Score...</option>
                                    <option value="1">Poor Protection</option>
                                    <option value="2">Fair Protection</option>
                                    <option value="3">Good Protection</option>
                                    <option value="4">Very Good Protection</option>
                                    <option value="5">Excellent Protection</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Governance Criteria Column -->
            <div class="strategy-column">
                <div class="strategy-category-container">
                    <h3 class="strategy-category-header">
                        <span class="ubs-text">LOMBARD ODIER</span> Governance Criteria
                    </h3>
                    <div class="strategy-list">
                        <div class="strategy-option">
                            <div class="strategy-header">
                                <label class="strategy-name">Board Structure</label>
                            </div>
                            <div class="strategy-description text-muted">Board composition, independence, and diversity</div>
                            <div class="score-input mt-2">
                                <select class="form-control">
                                    <option value="">Select Structure Score...</option>
                                    <option value="1">Poor Structure</option>
                                    <option value="2">Fair Structure</option>
                                    <option value="3">Good Structure</option>
                                    <option value="4">Very Good Structure</option>
                                    <option value="5">Excellent Structure</option>
                                </select>
                            </div>
                        </div>
                        <div class="strategy-option">
                            <div class="strategy-header">
                                <label class="strategy-name">Business Ethics</label>
                            </div>
                            <div class="strategy-description text-muted">Ethical practices, transparency, and compliance</div>
                            <div class="score-input mt-2">
                                <select class="form-control">
                                    <option value="">Select Ethics Score...</option>
                                    <option value="1">Poor Ethics</option>
                                    <option value="2">Fair Ethics</option>
                                    <option value="3">Good Ethics</option>
                                    <option value="4">Very Good Ethics</option>
                                    <option value="5">Excellent Ethics</option>
                                </select>
                            </div>
                        </div>
                        <div class="strategy-option">
                            <div class="strategy-header">
                                <label class="strategy-name">Risk Management</label>
                            </div>
                            <div class="strategy-description text-muted">Risk assessment and mitigation strategies</div>
                            <div class="score-input mt-2">
                                <select class="form-control">
                                    <option value="">Select Risk Score...</option>
                                    <option value="1">Poor Management</option>
                                    <option value="2">Fair Management</option>
                                    <option value="3">Good Management</option>
                                    <option value="4">Very Good Management</option>
                                    <option value="5">Excellent Management</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Risk Return Profile Section -->
        <h2 class="strategy-category-header" style="text-align:center;margin-bottom:2rem;">Risk Return Profile</h2>
        <div class="strategy-columns">
            <!-- Scenario Analysis Column -->
            <div class="strategy-column">
                <div class="strategy-category-container">
                    <h3 class="strategy-category-header">
                        <span class="ubs-text">LOMBARD ODIER</span> Scenario Analysis
                    </h3>
                    <div class="strategy-list">
                        <div class="strategy-option">
                            <div class="strategy-header">
                                <label class="strategy-name">Base Case</label>
                            </div>
                            <div class="strategy-description text-muted">Expected return under normal market conditions</div>
                            <div class="scenario-input mt-2">
                                <div class="input-group">
                                    <input type="number" 
                                           class="form-control scenario-value" 
                                           value="14" 
                                           step="0.1" 
                                           min="-100" 
                                           max="100"
                                           id="base-case-input">
                                    <div class="input-group-append">
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="strategy-option">
                            <div class="strategy-header">
                                <label class="strategy-name">Down Case</label>
                            </div>
                            <div class="strategy-description text-muted">Potential loss in adverse conditions</div>
                            <div class="scenario-input mt-2">
                                <div class="input-group">
                                    <input type="number" 
                                           class="form-control scenario-value" 
                                           value="-8" 
                                           step="0.1" 
                                           min="-100" 
                                           max="100"
                                           id="down-case-input">
                                    <div class="input-group-append">
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="strategy-option">
                            <div class="strategy-header">
                                <label class="strategy-name">Up Case</label>
                            </div>
                            <div class="strategy-description text-muted">Potential return in favorable conditions</div>
                            <div class="scenario-input mt-2">
                                <div class="input-group">
                                    <input type="number" 
                                           class="form-control scenario-value" 
                                           value="22" 
                                           step="0.1" 
                                           min="-100" 
                                           max="100"
                                           id="up-case-input">
                                    <div class="input-group-append">
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Risk Profile Column -->
            <div class="strategy-column">
                <div class="strategy-category-container">
                    <h3 class="strategy-category-header">
                        <span class="ubs-text">LOMBARD ODIER</span> Risk Profile
                    </h3>
                    <div class="strategy-list">
                        <div class="strategy-option">
                            <div class="strategy-header">
                                <input type="radio" name="risk-profile" id="conservative" value="conservative">
                                <label class="strategy-name" for="conservative">Conservative</label>
                            </div>
                            <div class="strategy-description text-muted">Lower risk, stable returns, capital preservation focus</div>
                            <div class="expected-return">Expected Return: 6-8%</div>
                        </div>
                        <div class="strategy-option">
                            <div class="strategy-header">
                                <input type="radio" name="risk-profile" id="balanced" value="balanced">
                                <label class="strategy-name" for="balanced">Balanced</label>
                            </div>
                            <div class="strategy-description text-muted">Moderate risk, balanced growth and stability</div>
                            <div class="expected-return">Expected Return: 8-12%</div>
                        </div>
                        <div class="strategy-option">
                            <div class="strategy-header">
                                <input type="radio" name="risk-profile" id="growth" value="growth">
                                <label class="strategy-name" for="growth">Growth</label>
                            </div>
                            <div class="strategy-description text-muted">Higher risk, focus on capital appreciation</div>
                            <div class="expected-return">Expected Return: 12-16%</div>
                        </div>
                        <div class="strategy-option">
                            <div class="strategy-header">
                                <input type="radio" name="risk-profile" id="aggressive" value="aggressive">
                                <label class="strategy-name" for="aggressive">Aggressive</label>
                            </div>
                            <div class="strategy-description text-muted">Highest risk, maximum growth potential</div>
                            <div class="expected-return">Expected Return: 16%+</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Risk Metrics Column -->
            <div class="strategy-column">
                <div class="strategy-category-container">
                    <h3 class="strategy-category-header">
                        <span class="ubs-text">LOMBARD ODIER</span> Risk Metrics
                    </h3>
                    <div class="strategy-list">
                        <div class="strategy-option">
                            <div class="strategy-header">
                                <label class="strategy-name">Volatility</label>
                            </div>
                            <div class="strategy-description text-muted">Portfolio price fluctuation measure</div>
                            <div class="risk-metric">12.5%</div>
                        </div>
                        <div class="strategy-option">
                            <div class="strategy-header">
                                <label class="strategy-name">Sharpe Ratio</label>
                            </div>
                            <div class="strategy-description text-muted">Risk-adjusted return measure</div>
                            <div class="risk-metric">1.8</div>
                        </div>
                        <div class="strategy-option">
                            <div class="strategy-header">
                                <label class="strategy-name">Maximum Drawdown</label>
                            </div>
                            <div class="strategy-description text-muted">Largest peak-to-trough decline</div>
                            <div class="risk-metric">-15.2%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div style="width:100%; display:flex; justify-content:space-between; align-items:center; margin-top: 24px;">
            <div id="mandate-save-status" style="font-size: 0.95rem; font-weight: 600;"></div>
            <button id="save-mandates-btn" style="background: #003f5c; color: #fff; border: none; border-radius: 6px; padding: 0.85rem 2.2rem; font-size: 1.1rem; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.10); cursor: pointer;">Save Selections</button>
        </div>
    </div>

    <!-- Available PE Investments Tab Content -->
    <div id="pe-investments-content" class="portfolio-tab-content">
        <div class="pe-investments-container">
            <h3>Private Equity Opportunities (Matched to Your Mandate)</h3>
            <div class="mandate-summary">
                <strong>Mandate summary:</strong> €2.5M commitment target • Strategies: Buyout/Growth/Secondaries/PC • Regions: Europe, North America • Sectors: Healthcare, Technology, Industrial • Ticket size: €250K–€500K • Co-invests: Yes
            </div>
            <div class="opportunity-filters">
                <button class="filter-btn active">Primary</button>
                <button class="filter-btn">Co-Invest</button>
                <button class="filter-btn">Secondary</button>
                <button class="filter-btn">Private Credit</button>
                <button class="filter-btn">Real Assets</button>
            </div>
            <div class="opportunities">
                <h4>Recommended for You</h4>
                <div class="opportunity-item">
                    <div class="opportunity-header">
                        <h5>Nordic Healthcare Growth Fund V — Growth, Europe</h5>
                    </div>
                    <p>Targets healthcare services and medtech across Nordics with proven digitization thesis and 3 successful exits in telehealth.</p>
                    <div class="opportunity-fit">
                        <strong>Why it fits:</strong>
                        <ul>
                            <li>Healthcare sector alignment with mandate</li>
                            <li>Fills 2024 vintage gap in growth allocation</li>
                            <li>Geographic diversification into Nordics</li>
                        </ul>
                    </div>
                    <div class="opportunity-terms">
                        <strong>Key terms:</strong> €400M target size, 2%/20% fees, 3% GP commitment
                    </div>
                    <div class="sponsor-track">
                        <strong>Sponsor track:</strong> DPI 1.8x / TVPI 2.4x / IRR 19.5%, recent exits include MedCore (3.2x) and HealthTech Solutions (2.8x)
                    </div>
                    <div class="opportunity-actions">
                        <button class="btn-primary">Request Diligence Pack</button>
                        <button class="btn-secondary">Soft-Circle €350K</button>
                        <button class="btn-outline">Speak to Banker</button>
                    </div>
                </div>
                <div class="opportunity-item">
                    <div class="opportunity-header">
                        <h5>European Software Secondary Portfolio — Secondary</h5>
                    </div>
                    <p>Portfolio rebalance opportunity from large pension fund seeking liquidity, featuring high-quality B2B software assets.</p>
                    <div class="opportunity-fit">
                        <strong>Deal angle:</strong> adds Software/Tech exposure without vintage drift, accelerated DPI path, fee-efficient exposure to mature assets.
                    </div>
                    <div class="opportunity-scenario">
                        <strong>Scenario:</strong> adds Technology exposure without vintage drift, targets 2.5x MOIC over 3-4 years.
                    </div>
                    <div class="opportunity-actions">
                        <button class="btn-primary">View Model</button>
                        <button class="btn-secondary">Hold/Pass</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.main-container {
    padding-top: 0.1rem !important;
}
.main-container h1, .main-container .fund-name {
    margin-top: 0 !important;
    padding-top: 0 !important;
}
.metrics-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 0.75rem;
    margin-bottom: 0.5rem !important;
}

.metric-item {
    background: white;
    padding: 1rem;
    border-radius: 0 !important;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    border: 1px solid #999 !important;
}

.metric-label {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 0.25rem;
}

.metric-value {
    font-size: 1.4rem;
    font-weight: 600;
    color: #333;
}

.charts-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 1rem;
    margin-bottom: 0.5rem !important;
}

.chart-section {
    background: white;
    padding: 1rem;
    border-radius: 0 !important;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    min-height: 350px;
    border: 1px solid #999 !important;
}

.chart-section h2 {
    margin: 0 0 0.75rem 0;
    font-size: 1.1rem;
}

.chart-wrapper {
    height: 300px;
    position: relative;
    margin-top: 0.5rem;
}

.portfolio-container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.portfolio-section {
    background: white;
    border-radius: 0 !important;
    padding: 1rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    margin-bottom: 0.5rem !important;
    border: 1px solid #999 !important;
}

.portfolio-section h2 {
    margin: 0 0 0.75rem 0;
    font-size: 1.1rem;
}

.table-container {
    overflow-x: auto;
    margin-top: 0.5rem;
}

.portfolio-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 800px;
    font-size: 0.9rem;
}

.portfolio-table th,
.portfolio-table td {
    padding: 0.6rem 0.75rem;
    border-bottom: 1px solid #eee;
    text-align: left;
}

.portfolio-table th {
    background-color: #f8f9fa;
    font-weight: 600;
    color: #333;
}

.portfolio-table td {
    font-size: 0.875rem;
}

/* Table Styles */
table {
    width: 100%;
    border-collapse: collapse;
    margin: 0.5rem 0;
}

th, td {
    padding: 0.6rem 0.75rem;
    border: 1px solid #e2e8f0;
}

th {
    background-color: #f8fafc;
    font-weight: 600;
}

/* Right justify numeric columns in Summary Portfolio Investments table */
.portfolio-table td:nth-child(2),
.portfolio-table th:nth-child(2),
.portfolio-table td:nth-child(3),
.portfolio-table th:nth-child(3),
.portfolio-table td:nth-child(4),
.portfolio-table th:nth-child(4),
.portfolio-table td:nth-child(5),
.portfolio-table th:nth-child(5),
.portfolio-table td:nth-child(6),
.portfolio-table th:nth-child(6),
.portfolio-table td:nth-child(8),
.portfolio-table th:nth-child(8),
.portfolio-table td:nth-child(9),
.portfolio-table th:nth-child(9) {
    text-align: right;
}

.value-cell {
    text-align: right;
}

.fund-link {
    color: #003f5c;
    text-decoration: none;
    font-weight: 600;
    transition: color 0.2s;
}

.fund-link:hover {
    color: #002b3f;
    text-decoration: underline;
}

/* Marketable Securities specific styles */
.symbol-cell {
    font-weight: 600;
    color: #003f5c;
    font-family: 'Courier New', monospace;
}

.number-cell, .currency-cell, .percentage-cell {
    text-align: right;
}

.positive {
    color: #16a085;
    font-weight: 600;
}

.negative {
    color: #e74c3c;
    font-weight: 600;
}

.currency-cell {
    font-family: 'Courier New', monospace;
}

.percentage-cell {
    font-weight: 600;
}

/* Total row styling */
.total-row {
    border-top: 2px solid #003f5c;
    background-color: #f8f9fa;
}

.total-row td {
    font-weight: 600;
    color: #003f5c;
    padding-top: 0.75rem;
    padding-bottom: 0.75rem;
}

/* Ensure total row numeric columns are right-aligned */
.total-row td:nth-child(2),
.total-row td:nth-child(3),
.total-row td:nth-child(4),
.total-row td:nth-child(5),
.total-row td:nth-child(6),
.total-row td:nth-child(8),
.total-row td:nth-child(9) {
    text-align: right;
}

/* Target Allocation and Deviation Styles */
.target-allocation-cell {
    text-align: center;
}

.target-allocation-input {
    width: 70px;
    padding: 0.25rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    text-align: center;
    font-size: 0.85rem;
}

.target-allocation-input:focus {
    outline: none;
    border-color: #003f5c;
    box-shadow: 0 0 0 2px rgba(0, 63, 92, 0.1);
}

.deviation-cell {
    text-align: center;
}

.deviation-value {
    font-weight: 600;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.85rem;
}

.deviation-positive {
    color: #d73527;
    background-color: #ffeaea;
}

.deviation-negative {
    color: #28a745;
    background-color: #eafaf1;
}

.deviation-zero {
    color: #6c757d;
    background-color: #f8f9fa;
}

.target-total-cell, .deviation-total-cell {
    text-align: center;
}

/* Target Allocation Controls */
.target-allocation-controls {
    display: flex;
    gap: 1rem;
    align-items: center;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #e9ecef;
}

.btn-primary, .btn-secondary, .btn-outline {
    padding: 0.5rem 1rem;
    border-radius: 4px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    border: 1px solid;
    transition: all 0.2s ease;
}

.btn-primary {
    background-color: #003f5c;
    color: white;
    border-color: #003f5c;
}

.btn-primary:hover {
    background-color: #002b3f;
    border-color: #002b3f;
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
    border-color: #6c757d;
}

.btn-secondary:hover {
    background-color: #545b62;
    border-color: #545b62;
}

.btn-outline {
    background-color: transparent;
    color: #003f5c;
    border-color: #003f5c;
}

.btn-outline:hover {
    background-color: #003f5c;
    color: white;
}

.save-status {
    font-size: 0.85rem;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-weight: 600;
}

.save-status.success {
    color: #155724;
    background-color: #d4edda;
}

.save-status.error {
    color: #721c24;
    background-color: #f8d7da;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .main-container {
        padding: 1rem;
    }
    
    .chart-section {
        min-height: 300px;
    }
    
    .chart-wrapper {
        height: 250px;
    }
}

/* Portfolio Tab Styles */
.portfolio-tabs {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
    border-bottom: 1px solid #e0e0e0;
}

.portfolio-tab {
    padding: 0.75rem 1.5rem;
    border: none;
    background: none;
    cursor: pointer;
    font-size: 1.4rem;
    font-weight: 600;
    border-bottom: 3px solid transparent;
    color: #666;
    transition: all 0.3s ease;
}

.portfolio-tab.active {
    border-bottom-color: #e31e24;
    color: #e31e24;
    font-weight: 700;
}

.portfolio-tab:hover {
    color: #e31e24;
}

.portfolio-tab-content {
    display: none;
}

.portfolio-tab-content.active {
    display: block;
}

.temporary-placeholder {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    text-align: center;
}

.temporary-placeholder h2 {
    margin: 0 0 1rem 0;
    color: #333;
}

.temporary-placeholder p {
    margin: 0;
    color: #666;
}

/* Strategy Selection Styles */
.strategy-columns {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.strategy-column {
    background: white;
    border-radius: 0 !important;
    padding: 1rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    border: 1px solid #999 !important;
}

.strategy-category-container {
    padding: 0.5rem;
}

.strategy-category-header {
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    font-size: 1.1rem;
    border-bottom: 2px solid #e31e24;
}

.ubs-text {
    color: #e31e24;
    font-weight: 700;
}

.strategy-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.strategy-option {
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    border: 1px solid #999 !important;
    border-radius: 0 !important;
    transition: all 0.3s ease;
}

.strategy-option:hover {
    border-color: #e31e24;
    background-color: #fafafa;
}

.strategy-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.strategy-name {
    font-size: 1rem;
    font-weight: 600;
    color: #333;
    margin: 0;
    cursor: pointer;
}

/* Ensure checkboxes are visible and clickable */
input[type="checkbox"].strategy-checkbox {
    appearance: auto;
    -webkit-appearance: checkbox;
    -moz-appearance: checkbox;
    display: inline-block !important;
    width: 16px !important;
    height: 16px !important;
    margin: 0 0.5rem 0 0 !important;
    cursor: pointer;
    vertical-align: middle;
}

.strategy-description {
    margin: 0.25rem 0;
    font-size: 0.9rem;
    color: #666;
}

.text-muted {
    color: #6c757d;
}

.selection-counter {
    text-align: center;
    margin-top: 1rem;
    font-size: 0.9rem;
}

.strategy-checkbox {
    margin-right: 0.5rem;
    width: 16px;
    height: 16px;
    cursor: pointer;
    display: inline-block;
    vertical-align: middle;
}

/* ESG and Form Control Styles */
.form-control {
    width: 100%;
    padding: 0.375rem 0.75rem;
    margin-bottom: 0.5rem;
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
    font-size: 0.875rem;
}

.form-control:focus {
    border-color: #e31e24;
    outline: 0;
    box-shadow: 0 0 0 0.2rem rgba(227, 30, 36, 0.25);
}

.score-input, .scenario-input {
    margin-top: 0.5rem;
}

.input-group {
    position: relative;
    display: flex;
    flex-wrap: wrap;
    align-items: stretch;
    width: 100%;
}

.input-group .form-control {
    position: relative;
    flex: 1 1 auto;
    width: 1%;
    margin-bottom: 0;
}

.input-group-append {
    margin-left: -1px;
    display: flex;
}

.input-group-text {
    display: flex;
    align-items: center;
    padding: 0.375rem 0.75rem;
    margin-bottom: 0;
    font-size: 0.875rem;
    font-weight: 400;
    line-height: 1.5;
    color: #495057;
    text-align: center;
    white-space: nowrap;
    background-color: #e9ecef;
    border: 1px solid #ced4da;
    border-radius: 0 0.25rem 0.25rem 0;
}

.expected-return {
    margin-top: 0.5rem;
    font-size: 0.85rem;
    font-weight: 600;
    color: #28a745;
}

.risk-metric {
    margin-top: 0.5rem;
    font-size: 1.1rem;
    font-weight: 700;
    color: #e31e24;
}

.mt-2 {
    margin-top: 0.5rem;
}

/* Available PE Investments Styles */
.pe-investments-container {
    background: white;
    padding: 2rem;
    border-radius: 0 !important;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    border: 1px solid #999 !important;
}

.pe-investments-container h3 {
    margin: 0 0 1rem 0;
    color: #333;
    font-size: 1.5rem;
}

.mandate-summary {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 0 !important;
    margin-bottom: 1.5rem;
    font-size: 0.9rem;
    border-left: 4px solid #e31e24;
    border: 1px solid #999 !important;
}

.opportunity-filters {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
}

.filter-btn {
    padding: 0.5rem 1rem;
    border: 1px solid #999 !important;
    background: white;
    border-radius: 0 !important;
    cursor: pointer;
    font-size: 0.875rem;
    transition: all 0.3s ease;
}

.filter-btn.active,
.filter-btn:hover {
    background: #e31e24;
    color: white;
    border-color: #e31e24;
}

.opportunities h4 {
    margin: 0 0 1rem 0;
    color: #333;
    font-size: 1.2rem;
}

.opportunity-item {
    background: #fafafa;
    border: 1px solid #999 !important;
    border-radius: 0 !important;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.opportunity-header h5 {
    margin: 0 0 0.75rem 0;
    color: #e31e24;
    font-size: 1.1rem;
    font-weight: 600;
}

.opportunity-item p {
    margin: 0 0 1rem 0;
    color: #666;
    line-height: 1.5;
}

.opportunity-fit,
.opportunity-terms,
.opportunity-scenario,
.sponsor-track {
    margin: 1rem 0;
    padding: 0.75rem;
    background: white;
    border-radius: 4px;
    border-left: 3px solid #e31e24;
}

.opportunity-fit ul {
    margin: 0.5rem 0 0 0;
    padding-left: 1.5rem;
}

.opportunity-fit li {
    margin-bottom: 0.25rem;
    color: #666;
}

.opportunity-actions {
    display: flex;
    gap: 0.75rem;
    margin-top: 1rem;
    flex-wrap: wrap;
}

.btn-primary,
.btn-secondary,
.btn-outline {
    padding: 0.5rem 1rem;
    border-radius: 4px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    border: 1px solid;
}

.btn-primary {
    background: #e31e24;
    color: white;
    border-color: #e31e24;
}

.btn-primary:hover {
    background: #c4161b;
}

.btn-secondary {
    background: #6c757d;
    color: white;
    border-color: #6c757d;
}

.btn-secondary:hover {
    background: #545b62;
}

.btn-outline {
    background: transparent;
    color: #e31e24;
    border-color: #e31e24;
}

.btn-outline:hover {
    background: #e31e24;
    color: white;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get the chart contexts
    const assetAllocationCtx = document.getElementById('assetAllocationChart').getContext('2d');
    const geographicAllocationCtx = document.getElementById('geographicAllocationChart').getContext('2d');
    const portfolioPerformanceCtx = document.getElementById('portfolioPerformanceChart').getContext('2d');

    // Parse the data from server
    const assetAllocation = <%- JSON.stringify(processedData.metrics.assetAllocation) %>;
    const geographicAllocation = <%- JSON.stringify(processedData.metrics.geographicAllocation) %>;
    const assetTypeBreakdown = <%- JSON.stringify(processedData.metrics.assetTypeBreakdown) %>;

    // Professional color palette
    const businessColors = {
        primary: [
            '#003f5c',  // Deep Blue
            '#2f4b7c',  // Navy Blue
            '#665191',  // Royal Purple
            '#a05195',  // Plum
            '#d45087',  // Burgundy
            '#f95d6a',  // Deep Red
            '#ff7c43',  // Burnt Orange
            '#ffa600'   // Gold
        ],
        geographic: [
            '#003f5c',  // Deep Blue
            '#444e86',  // Navy
            '#955196',  // Purple
            '#dd5182'   // Burgundy
        ],
        bar: {
            background: '#003f5c',
            border: '#002b3f'
        }
    };

    // Asset Allocation Chart
    new Chart(assetAllocationCtx, {
        type: 'pie',
        data: {
            labels: Object.keys(assetAllocation),
            datasets: [{
                data: Object.values(assetAllocation),
                backgroundColor: businessColors.primary
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: {
                            size: 11
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.label}: ${context.raw}%`;
                        }
                    }
                },
                datalabels: {
                    color: '#fff',
                    font: {
                        weight: 'bold',
                        size: 14
                    },
                    formatter: function(value) {
                        return value + '%';
                    }
                }
            }
        },
        plugins: [{
            beforeDraw: function(chart) {
                var ctx = chart.ctx;
                ctx.save();
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.font = '14px Arial';
                ctx.fillStyle = '#fff';

                var total = chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                chart.data.datasets[0].data.forEach(function(value, i) {
                    var meta = chart.getDatasetMeta(0);
                    var arc = meta.data[i];
                    var centerX = (arc.x + arc.x) / 2;
                    var centerY = (arc.y + arc.y) / 2;
                    ctx.fillText(value + '%', centerX, centerY);
                });
                ctx.restore();
            }
        }]
    });

    // Geographic Distribution Chart
    new Chart(geographicAllocationCtx, {
        type: 'pie',
        data: {
            labels: Object.keys(geographicAllocation),
            datasets: [{
                data: Object.values(geographicAllocation),
                backgroundColor: businessColors.geographic
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: {
                            size: 11
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.label}: ${context.raw}%`;
                        }
                    }
                },
                datalabels: {
                    color: '#fff',
                    font: {
                        weight: 'bold',
                        size: 14
                    },
                    formatter: function(value) {
                        return value + '%';
                    }
                }
            }
        },
        plugins: [{
            beforeDraw: function(chart) {
                var ctx = chart.ctx;
                ctx.save();
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.font = '14px Arial';
                ctx.fillStyle = '#fff';

                var total = chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                chart.data.datasets[0].data.forEach(function(value, i) {
                    var meta = chart.getDatasetMeta(0);
                    var arc = meta.data[i];
                    var centerX = (arc.x + arc.x) / 2;
                    var centerY = (arc.y + arc.y) / 2;
                    ctx.fillText(value + '%', centerX, centerY);
                });
                ctx.restore();
            }
        }]
    });

    // Calculate total values for each asset type
    const totalValue = <%= processedData.metrics.totalValue %>;
    const assetValues = {};
    Object.keys(assetAllocation).forEach(assetType => {
        assetValues[assetType] = (assetAllocation[assetType] / 100) * totalValue;
    });

    // Portfolio Performance Chart (Line Chart) - From Inception with Fluctuations
    const performanceData = {
        labels: ['Jan 2020', 'Apr 2020', 'Jul 2020', 'Oct 2020', 'Jan 2021', 'Apr 2021', 'Jul 2021', 'Oct 2021',
                'Jan 2022', 'Apr 2022', 'Jul 2022', 'Oct 2022', 'Jan 2023', 'Apr 2023', 'Jul 2023', 'Oct 2023',
                'Jan 2024', 'Apr 2024', 'Jul 2024', 'Oct 2024', 'Jan 2025', 'Apr 2025', 'Jul 2025', 'Sep 2025'],
        datasets: [{
            label: 'Portfolio Value (€)',
            data: [10000000, 8750000, 9200000, 10500000, 11800000, 12200000, 13100000, 12800000,
                  13500000, 12900000, 11800000, 12400000, 13800000, 14500000, 15200000, 14800000,
                  15600000, 16200000, 17100000, 16800000, 17500000, 18200000, 19100000, 20000000],
            borderColor: '#003f5c',
            backgroundColor: 'rgba(0, 63, 92, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.3,
            pointRadius: 3,
            pointHoverRadius: 6,
            pointBackgroundColor: '#003f5c',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2
        }]
    };

    new Chart(portfolioPerformanceCtx, {
        type: 'line',
        data: performanceData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Time Period (Since Inception)'
                    },
                    grid: {
                        display: false
                    },
                    ticks: {
                        maxTicksLimit: 8
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Portfolio Value (€)'
                    },
                    ticks: {
                        callback: function(value) {
                            return '€' + (value / 1000000).toFixed(1) + 'M';
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: 'white',
                    bodyColor: 'white',
                    borderColor: '#003f5c',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': €' + context.raw.toLocaleString('de-DE');
                        }
                    }
                }
            }
        }
    });

});

// Global Target Allocation and Deviation Calculation
window.calculateDeviations = function() {
    console.log('=== CALCULATION STARTED ===');
    
    const targetInputs = document.querySelectorAll('.target-allocation-input');
    console.log('Found target inputs:', targetInputs.length);
    
    let totalTarget = 0;
    
    // Get the total portfolio value for dollar calculations
    const totalPortfolioValue = 20000000; // This should match the processedData.metrics.totalValue from server

    targetInputs.forEach((input, index) => {
        const row = input.closest('tr');
        if (!row || row.classList.contains('total-row')) {
            console.log('Skipping row', index, '- total row or no row');
            return;
        }
        
        const currentAllocationCell = row.querySelector('.current-allocation');
        const deviationCell = row.querySelector('.deviation-value');
        const deviationDollarCell = row.querySelector('.deviation-dollar-value');
        const assetType = row.getAttribute('data-asset-type');
        
        if (!currentAllocationCell || !deviationCell || !deviationDollarCell) {
            console.log('Missing cells for row', index);
            return;
        }
        
        const currentAllocation = parseFloat(currentAllocationCell.textContent.replace('%', ''));
        const targetAllocation = parseFloat(input.value) || 0;
        const deviation = currentAllocation - targetAllocation;
        
        // Calculate dollar deviation
        const deviationDollar = (deviation / 100) * totalPortfolioValue;
        
        console.log(`${assetType}: Current=${currentAllocation}%, Target=${targetAllocation}%, Deviation=${deviation.toFixed(2)}%, Deviation$=${deviationDollar.toLocaleString()}`);
        
        // Update individual deviation percentage
        deviationCell.textContent = (deviation >= 0 ? '+' : '') + deviation.toFixed(2) + '%';
        
        // Update individual deviation dollar amount
        const formattedDeviationDollar = (deviationDollar >= 0 ? '+€' : '-€') + Math.abs(deviationDollar).toLocaleString('de-DE');
        deviationDollarCell.textContent = formattedDeviationDollar;
        
        // Set base classes without color coding
        deviationCell.className = 'deviation-value';
        deviationDollarCell.className = 'deviation-dollar-value';
        
        // Add to totals
        totalTarget += targetAllocation;
    });

    console.log('TOTAL TARGET CALCULATED:', totalTarget.toFixed(2) + '%');

    // Update target total display
    const targetTotalElement = document.getElementById('target-total');
    if (targetTotalElement) {
        console.log('Updating target total element to:', totalTarget.toFixed(2) + '%');
        targetTotalElement.textContent = totalTarget.toFixed(2) + '%';
        
        // Color code based on whether it equals 100%
        if (Math.abs(totalTarget - 100) < 0.01) {
            targetTotalElement.style.color = '#28a745';
        } else {
            targetTotalElement.style.color = '#d73527';
        }
    } else {
        console.log('ERROR: target-total element not found!');
    }
    
    // Deviation % total is not meaningful, so we skip updating it
    
    // Deviation $ total is also not meaningful, so we skip updating it
    
    console.log('=== CALCULATION COMPLETED ===');
};

// Setup event listeners on DOM ready
document.addEventListener('DOMContentLoaded', function() {
    // Set current date
    const portfolioDateElement = document.getElementById('portfolio-date');
    if (portfolioDateElement) {
        const today = new Date();
        const options = { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric'
        };
        portfolioDateElement.textContent = today.toLocaleDateString('en-US', options);
    }

    // Save and Load Target Allocations
    function saveTargetAllocations() {
        const targets = {};
        const inputs = document.querySelectorAll('.target-allocation-input');
        
        inputs.forEach(input => {
            const row = input.closest('tr');
            const assetType = row.getAttribute('data-asset-type');
            targets[assetType] = parseFloat(input.value) || 0;
        });
        
        localStorage.setItem('portfolioTargetAllocations', JSON.stringify(targets));
        
        // Show success message
        const statusElement = document.getElementById('save-status');
        statusElement.textContent = 'Target allocations saved!';
        statusElement.className = 'save-status success';
        setTimeout(() => {
            statusElement.textContent = '';
            statusElement.className = 'save-status';
        }, 3000);
    }
    
    function loadTargetAllocations() {
        const savedTargets = localStorage.getItem('portfolioTargetAllocations');
        
        if (savedTargets) {
            const targets = JSON.parse(savedTargets);
            const inputs = document.querySelectorAll('.target-allocation-input');
            
            inputs.forEach(input => {
                const row = input.closest('tr');
                const assetType = row.getAttribute('data-asset-type');
                if (targets[assetType] !== undefined) {
                    input.value = targets[assetType].toFixed(2);
                }
            });
            
            window.calculateDeviations();
            
            // Show success message
            const statusElement = document.getElementById('save-status');
            statusElement.textContent = 'Target allocations loaded!';
            statusElement.className = 'save-status success';
            setTimeout(() => {
                statusElement.textContent = '';
                statusElement.className = 'save-status';
            }, 3000);
        } else {
            // Show error message
            const statusElement = document.getElementById('save-status');
            statusElement.textContent = 'No saved target allocations found.';
            statusElement.className = 'save-status error';
            setTimeout(() => {
                statusElement.textContent = '';
                statusElement.className = 'save-status';
            }, 3000);
        }
    }
    
    function resetToCurrentAllocations() {
        const inputs = document.querySelectorAll('.target-allocation-input');
        
        inputs.forEach(input => {
            const row = input.closest('tr');
            const currentAllocationText = row.querySelector('.current-allocation').textContent;
            const currentAllocation = parseFloat(currentAllocationText.replace('%', ''));
            input.value = currentAllocation.toFixed(2);
        });
        
        calculateDeviations();
        
        // Show success message
        const statusElement = document.getElementById('save-status');
        statusElement.textContent = 'Reset to current allocations!';
        statusElement.className = 'save-status success';
        setTimeout(() => {
            statusElement.textContent = '';
            statusElement.className = 'save-status';
        }, 3000);
    }

    // Add event listeners to all target allocation inputs
    const inputs = document.querySelectorAll('.target-allocation-input');
    
    inputs.forEach((input) => {
        input.addEventListener('input', window.calculateDeviations);
        input.addEventListener('change', window.calculateDeviations);
        input.addEventListener('blur', window.calculateDeviations);
    });
        
        // Add button event listeners
        document.getElementById('save-targets').addEventListener('click', saveTargetAllocations);
        document.getElementById('load-targets').addEventListener('click', loadTargetAllocations);
        document.getElementById('reset-targets').addEventListener('click', resetToCurrentAllocations);
    document.getElementById('test-calc').addEventListener('click', function() {
        console.log('Test button clicked - triggering calculation...');
        window.calculateDeviations();
    });
    
    // Auto-load saved targets on page load
    const savedTargets = localStorage.getItem('portfolioTargetAllocations');
    if (savedTargets) {
        loadTargetAllocations();
    } else {
        // Initial calculation
        setTimeout(window.calculateDeviations, 100);
    }
    });

// Portfolio Tab Switching Function
function showPortfolioTab(tabName) {
    // Remove active class from all content
    document.querySelectorAll('.portfolio-tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    // Update page title
    const titleElement = document.getElementById('portfolio-page-title');
    if (titleElement) {
        if (tabName === 'summary') {
            titleElement.textContent = 'Portfolio Summary';
            document.getElementById('portfolio-summary-content').classList.add('active');
        } else if (tabName === 'temporary') {
            titleElement.textContent = 'Client Mandates';
            document.getElementById('temporary-content').classList.add('active');
        } else if (tabName === 'pe-investments') {
            titleElement.textContent = 'Available PE Investments';
            document.getElementById('pe-investments-content').classList.add('active');
        }
    }
}

// Initialize tab from URL parameter on page load
document.addEventListener('DOMContentLoaded', function() {
    const params = new URLSearchParams(window.location.search);
    const tab = params.get('tab') || 'summary';
    showPortfolioTab(tab);
});

// Strategy Selection Counter Functionality
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.strategy-checkbox');
    const selectedCountElement = document.getElementById('selected-count');
    
    function updateSelectedCount() {
        const selectedCount = document.querySelectorAll('.strategy-checkbox:checked').length;
        if (selectedCountElement) {
            selectedCountElement.textContent = selectedCount;
        }
    }
    
    // Add event listeners to all strategy checkboxes
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCount);
    });
    
    // Initial count
    updateSelectedCount();
    
    // Save Client Mandates Functionality
    const saveMandatesBtn = document.getElementById('save-mandates-btn');
    const mandateSaveStatus = document.getElementById('mandate-save-status');
    
    if (saveMandatesBtn) {
        saveMandatesBtn.addEventListener('click', function() {
            // Collect all selections
            const mandateData = {
                strategies: [],
                esgScores: {},
                riskProfile: null,
                scenarioAnalysis: {}
            };
            
            // Collect selected strategies
            document.querySelectorAll('.strategy-checkbox:checked').forEach(checkbox => {
                mandateData.strategies.push(checkbox.id);
            });
            
            // Collect ESG scores
            document.querySelectorAll('#temporary-content .score-input select').forEach(select => {
                if (select.value) {
                    const label = select.closest('.strategy-option').querySelector('.strategy-name').textContent;
                    mandateData.esgScores[label] = select.value;
                }
            });
            
            // Collect Risk Profile
            const selectedRiskProfile = document.querySelector('input[name="risk-profile"]:checked');
            if (selectedRiskProfile) {
                mandateData.riskProfile = selectedRiskProfile.value;
            }
            
            // Collect Scenario Analysis
            const baseCaseInput = document.getElementById('base-case-input');
            const downCaseInput = document.getElementById('down-case-input');
            const upCaseInput = document.getElementById('up-case-input');
            
            if (baseCaseInput) mandateData.scenarioAnalysis.baseCase = baseCaseInput.value;
            if (downCaseInput) mandateData.scenarioAnalysis.downCase = downCaseInput.value;
            if (upCaseInput) mandateData.scenarioAnalysis.upCase = upCaseInput.value;
            
            // Save to backend
            fetch('/api/save-client-mandates', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(mandateData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mandateSaveStatus.textContent = '✓ Selections saved successfully!';
                    mandateSaveStatus.style.color = '#28a745';
                    setTimeout(() => {
                        mandateSaveStatus.textContent = '';
                    }, 3000);
                } else {
                    mandateSaveStatus.textContent = '✗ Error saving selections';
                    mandateSaveStatus.style.color = '#dc3545';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mandateSaveStatus.textContent = '✗ Error saving selections';
                mandateSaveStatus.style.color = '#dc3545';
            });
        });
    }
    
    function loadClientMandates() {
        fetch('/api/get-client-mandates')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.mandates) {
                    const mandates = data.mandates;
                    
                    // Clear all selections first
                    document.querySelectorAll('.strategy-checkbox').forEach(cb => cb.checked = false);
                    document.querySelectorAll('#temporary-content .score-input select').forEach(s => s.value = '');
                    document.querySelectorAll('input[name="risk-profile"]').forEach(r => r.checked = false);
                    
                    // Load strategies
                    if (mandates.strategies) {
                        mandates.strategies.forEach(strategyId => {
                            const checkbox = document.getElementById(strategyId);
                            if (checkbox) checkbox.checked = true;
                        });
                        updateSelectedCount();
                    }
                    
                    // Load ESG scores
                    if (mandates.esgScores) {
                        document.querySelectorAll('#temporary-content .score-input select').forEach(select => {
                            const label = select.closest('.strategy-option').querySelector('.strategy-name').textContent;
                            if (mandates.esgScores[label]) {
                                select.value = mandates.esgScores[label];
                            }
                        });
                    }
                    
                    // Load Risk Profile
                    if (mandates.riskProfile) {
                        const riskRadio = document.getElementById(mandates.riskProfile);
                        if (riskRadio) riskRadio.checked = true;
                    }
                    
                    // Load Scenario Analysis
                    if (mandates.scenarioAnalysis) {
                        const baseCaseInput = document.getElementById('base-case-input');
                        const downCaseInput = document.getElementById('down-case-input');
                        const upCaseInput = document.getElementById('up-case-input');
                        
                        if (baseCaseInput && mandates.scenarioAnalysis.baseCase) {
                            baseCaseInput.value = mandates.scenarioAnalysis.baseCase;
                        }
                        if (downCaseInput && mandates.scenarioAnalysis.downCase) {
                            downCaseInput.value = mandates.scenarioAnalysis.downCase;
                        }
                        if (upCaseInput && mandates.scenarioAnalysis.upCase) {
                            upCaseInput.value = mandates.scenarioAnalysis.upCase;
                        }
                    }
                    
                    mandateSaveStatus.textContent = '✓ Selections loaded successfully!';
                    mandateSaveStatus.style.color = '#28a745';
                    setTimeout(() => {
                        mandateSaveStatus.textContent = '';
                    }, 3000);
                } else {
                    mandateSaveStatus.textContent = 'No saved selections found';
                    mandateSaveStatus.style.color = '#6c757d';
                    setTimeout(() => {
                        mandateSaveStatus.textContent = '';
                    }, 3000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mandateSaveStatus.textContent = '✗ Error loading selections';
                mandateSaveStatus.style.color = '#dc3545';
            });
    }
    
    // Auto-load saved mandates on page load
    loadClientMandates();
});
</script>

<%- include('partials/footer') %> < ! - -   F o r c e   r e f r e s h   - - > 
 
 