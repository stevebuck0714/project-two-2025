<%- include('partials/header') %>
<%- include('partials/secondary-nav') %>

<div class="stability-message">
    <h2>Messages</h2>
</div>

<style>
/* Remove rounded corners and darker borders */
.messages-section,
.message-item {
    border-radius: 0 !important;
    border-color: #999 !important;
}
</style>

<div class="main-container">
    
    <div class="messages-container">
        <div class="message-tabs">
            <button class="message-tab active" onclick="showMessageTab('inbox')">Inbox</button>
            <button class="message-tab" onclick="showMessageTab('sent')">Sent Messages</button>
            <% if (user && user.type === 'banker') { %>
            <button class="message-tab" onclick="showMessageTab('approved')">Approved Emails</button>
            <% } %>
        </div>
        
        <div class="messages-section" id="inbox-section">
            <div class="message-list" id="inbox-messages">
                <div style="text-align: center; padding: 40px; color: #999;">
                    <p>Loading messages...</p>
                </div>
            </div>
        </div>
        
        <script>
        // Load messages from API
        document.addEventListener('DOMContentLoaded', function() {
            loadMessages();
        });
        
        function loadMessages() {
            fetch('/api/get-messages')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayMessages(data.messages);
                    } else {
                        document.getElementById('inbox-messages').innerHTML = '<div style="text-align: center; padding: 40px; color: #999;"><p>No messages yet</p></div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading messages:', error);
                    document.getElementById('inbox-messages').innerHTML = '<div style="text-align: center; padding: 40px; color: #999;"><p>Error loading messages</p></div>';
                });
        }
        
        function displayMessages(messages) {
            // Separate inbox and sent messages
            const inboxMessages = messages.filter(msg => msg.type === 'inbox');
            const sentMessages = messages.filter(msg => msg.type === 'sent');
            
            // Display inbox messages
            displayMessageList(inboxMessages, 'inbox-messages', 'inbox');
            
            // Display sent messages
            displayMessageList(sentMessages, 'sent-messages', 'sent');
        }
        
        function displayMessageList(messages, containerId, type) {
            const container = document.getElementById(containerId);
            
            if (messages.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;"><p>No messages yet</p></div>';
                return;
            }
            
            // Sort messages by date (newest first)
            messages.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let html = '';
            messages.forEach(msg => {
                const messageDate = new Date(msg.date);
                const now = new Date();
                const diffHours = Math.floor((now - messageDate) / (1000 * 60 * 60));
                const diffDays = Math.floor(diffHours / 24);
                
                let dateString;
                if (diffHours < 1) {
                    dateString = 'Just now';
                } else if (diffHours < 24) {
                    dateString = `Today, ${messageDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}`;
                } else if (diffDays === 1) {
                    dateString = `Yesterday, ${messageDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}`;
                } else if (diffDays < 7) {
                    dateString = `${diffDays} days ago`;
                } else {
                    dateString = messageDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }
                
                const unreadClass = msg.unread ? 'unread' : '';
                const sentClass = type === 'sent' ? 'sent' : '';
                const label = type === 'sent' ? 'To:' : 'From:';
                const displayName = type === 'sent' ? msg.to : msg.from;
                
                html += `
                    <div class="message-item ${unreadClass} ${sentClass}" onclick="viewMessage('${msg.id}')">
                        <div class="message-header">
                            <h3>${label} ${displayName} - ${msg.subject}</h3>
                            <span class="date">${dateString}</span>
                        </div>
                        <p class="preview">${msg.preview}</p>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function viewMessage(messageId) {
            // Fetch the full message
            fetch('/api/get-messages')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const message = data.messages.find(msg => msg.id === messageId);
                        if (message) {
                            showMessageModal(message);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading message:', error);
                });
        }
        
        function showMessageModal(message) {
            const messageDate = new Date(message.date);
            const formattedDate = messageDate.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const isSent = message.type === 'sent';
            const fromToLabel = isSent ? 'To:' : 'From:';
            const fromToValue = isSent ? message.to : message.from;
            const replyToAddress = isSent ? message.to : message.from;
            
            const modalHtml = `
                <div class="message-modal-overlay" onclick="closeMessageModal()">
                    <div class="message-modal" onclick="event.stopPropagation()">
                        <div class="message-modal-header">
                            <div>
                                <h2>${message.subject}</h2>
                                <div class="message-meta">
                                    <span><strong>${fromToLabel}</strong> ${fromToValue}</span>
                                    <span><strong>Date:</strong> ${formattedDate}</span>
                                </div>
                            </div>
                            <button class="close-modal-btn" onclick="closeMessageModal()">×</button>
                        </div>
                        <div class="message-modal-body">
                            <pre>${message.fullMessage}</pre>
                        </div>
                        <div class="message-modal-footer">
                            <button class="btn btn-danger" onclick="deleteMessage('${message.id}')">Delete</button>
                            <button class="btn btn-primary" onclick="replyToMessage('${replyToAddress}', '${message.subject}')">Reply</button>
                            <button class="btn btn-secondary" onclick="closeMessageModal()">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        function closeMessageModal() {
            const modal = document.querySelector('.message-modal-overlay');
            if (modal) {
                modal.remove();
            }
        }
        
        function deleteMessage(messageId) {
            if (!confirm('Are you sure you want to delete this message?')) {
                return;
            }
            
            fetch('/api/delete-message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ messageId: messageId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeMessageModal();
                    loadMessages(); // Reload the message list
                    alert('Message deleted successfully');
                } else {
                    alert('Failed to delete message');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to delete message');
            });
        }
        
        function replyToMessage(fromAddress, subject) {
            // Close the modal
            closeMessageModal();
            
            // For now, just show an alert about replying
            // In a full implementation, this could open a compose window or redirect to contact form
            alert('Reply feature: This would open a compose window to reply to ' + fromAddress + ' about "' + subject + '"');
        }
        </script>
        
        <style>
        .message-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }
        
        .message-modal {
            background: white;
            border-radius: 8px;
            max-width: 800px;
            width: 100%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .message-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 20px;
            border-bottom: 1px solid #ddd;
            gap: 20px;
        }
        
        .message-modal-header h2 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1.5rem;
            line-height: 1.3;
        }
        
        .message-meta {
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-size: 0.9rem;
            color: #666;
        }
        
        .close-modal-btn {
            background: none;
            border: none;
            font-size: 2rem;
            color: #999;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            flex-shrink: 0;
        }
        
        .close-modal-btn:hover {
            background: #f0f0f0;
            color: #333;
        }
        
        .message-modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        
        .message-modal-body pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: inherit;
            font-size: 1rem;
            line-height: 1.6;
            margin: 0;
            color: #333;
        }
        
        .message-modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .message-modal-footer .btn {
            padding: 0.6rem 1.5rem;
            border: none;
            border-radius: 4px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .message-modal-footer .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .message-modal-footer .btn-primary:hover {
            background: #0056b3;
        }
        
        .message-modal-footer .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .message-modal-footer .btn-secondary:hover {
            background: #5a6268;
        }
        
        .message-modal-footer .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .message-modal-footer .btn-danger:hover {
            background: #c82333;
        }
        
        .message-item {
            cursor: pointer;
        }
        
        .message-item:hover {
            background-color: #f8f9fa;
        }
        </style>
        
        <div class="messages-section" id="sent-section" style="display: none;">
            <div class="message-list" id="sent-messages">
                <div style="text-align: center; padding: 40px; color: #999;">
                    <p>Loading sent messages...</p>
                </div>
            </div>
        </div>
        
        <% if (user && user.type === 'banker') { %>
        <div class="messages-section" id="approved-section" style="display: none;">
            <div class="approved-emails-container">
                <div class="approved-emails-intro">
                    <h3>Approved Email Templates</h3>
                    <p>Select a template below to compose and send an approved email. All required fields must be completed before sending.</p>
                </div>
                <div class="approved-email-list" id="approved-email-list">
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <p>Loading email templates...</p>
                    </div>
                </div>
            </div>
        </div>
        <% } %>
    </div>
</div>

<style>
.message-tabs {
    display: flex;
    border-bottom: 2px solid #e0e6ed;
    margin-bottom: 0.75rem;
    gap: 0;
}

.message-tab {
    padding: 0.5rem 1.25rem;
    border: none;
    background: transparent;
    font-size: 0.95rem;
    font-weight: 500;
    color: #666;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
}

.message-tab.active {
    color: #e60012;
    border-bottom-color: #e60012;
    background: #f8fafc;
}

.message-tab:hover {
    color: #e60012;
    background: #f8fafc;
}

.message-item.sent {
    border-left: 4px solid #28a745;
    background: #f8fff9;
}

.message-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 0.35rem;
    font-size: 0.8rem;
    color: #666;
}

.recipient {
    font-weight: 500;
}

.status {
    color: #28a745;
    font-weight: 500;
}

.messages-section {
    min-height: auto;
}

/* Approved Emails Styles */
.approved-emails-intro {
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 20px;
}

.approved-emails-intro h3 {
    margin: 0 0 10px 0;
    color: #333;
}

.approved-emails-intro p {
    margin: 0;
    color: #666;
}

.email-template-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 20px;
    padding: 10px 0;
}

.email-template-card {
    background: white;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}

.email-template-card:hover {
    border-color: #e60012;
    box-shadow: 0 4px 12px rgba(230, 0, 18, 0.1);
    transform: translateY(-2px);
}

.template-number {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #e60012;
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.9rem;
}

.template-title {
    margin: 0 0 10px 0;
    color: #333;
    font-size: 1.1rem;
    padding-right: 40px;
}

.template-recipient {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 10px;
    font-weight: 500;
}

.template-subject {
    color: #999;
    font-size: 0.85rem;
    margin-bottom: 15px;
    font-style: italic;
    line-height: 1.4;
}

.btn-use-template {
    background: #e60012;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
    width: 100%;
}

.btn-use-template:hover {
    background: #c00010;
}

/* Email Composer Modal Styles */
.email-composer-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    padding: 20px;
}

.email-composer-modal {
    background: white;
    border-radius: 8px;
    max-width: 900px;
    width: 100%;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
}

.composer-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 25px;
    border-bottom: 2px solid #e0e0e0;
}

.composer-header h2 {
    margin: 0;
    color: #333;
    font-size: 1.5rem;
}

.composer-body {
    padding: 25px;
    overflow-y: auto;
    flex: 1;
}

.template-info {
    padding: 15px;
    background: #f8f9fa;
    border-left: 4px solid #e60012;
    margin-bottom: 20px;
    line-height: 1.8;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
}

.form-control {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.95rem;
    transition: border-color 0.2s;
    box-sizing: border-box;
}

.form-control:focus {
    outline: none;
    border-color: #e60012;
}

.preview-box {
    background: #f8f9fa;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    padding: 15px;
    font-size: 0.95rem;
    line-height: 1.6;
    color: #333;
    min-height: 60px;
}

.preview-body {
    white-space: pre-wrap;
    min-height: 200px;
    font-family: monospace;
    font-size: 0.85rem;
}

.composer-footer {
    padding: 15px 25px;
    border-top: 2px solid #e0e0e0;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

.composer-footer .btn {
    padding: 10px 24px;
    border: none;
    border-radius: 4px;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.composer-footer .btn-primary {
    background: #e60012;
    color: white;
}

.composer-footer .btn-primary:hover {
    background: #c00010;
}

.composer-footer .btn-secondary {
    background: #6c757d;
    color: white;
}

.composer-footer .btn-secondary:hover {
    background: #5a6268;
}
</style>

<script>
let emailTemplatesCache = [];

function showMessageTab(tabName) {
    // Hide all sections
    document.getElementById('inbox-section').style.display = 'none';
    document.getElementById('sent-section').style.display = 'none';
    const approvedSection = document.getElementById('approved-section');
    if (approvedSection) {
        approvedSection.style.display = 'none';
    }
    
    // Remove active class from all tabs
    document.querySelectorAll('.message-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected section and activate tab
    if (tabName === 'inbox') {
        document.getElementById('inbox-section').style.display = 'block';
        document.querySelector('.message-tab[onclick*="inbox"]').classList.add('active');
    } else if (tabName === 'sent') {
        document.getElementById('sent-section').style.display = 'block';
        document.querySelector('.message-tab[onclick*="sent"]').classList.add('active');
    } else if (tabName === 'approved' && approvedSection) {
        approvedSection.style.display = 'block';
        document.querySelector('.message-tab[onclick*="approved"]').classList.add('active');
        // Load email templates when tab is shown
        if (emailTemplatesCache.length === 0) {
            loadEmailTemplates();
        }
    }
}

// Load email templates from API
function loadEmailTemplates() {
    fetch('/api/get-email-templates')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                emailTemplatesCache = data.templates;
                displayEmailTemplates(data.templates);
            } else {
                document.getElementById('approved-email-list').innerHTML = '<div style="text-align: center; padding: 40px; color: #999;"><p>No email templates available</p></div>';
            }
        })
        .catch(error => {
            console.error('Error loading email templates:', error);
            document.getElementById('approved-email-list').innerHTML = '<div style="text-align: center; padding: 40px; color: #999;"><p>Error loading email templates</p></div>';
        });
}

// Display email templates as cards
function displayEmailTemplates(templates) {
    const container = document.getElementById('approved-email-list');
    
    if (templates.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;"><p>No email templates available</p></div>';
        return;
    }
    
    let html = '<div class="email-template-grid">';
    templates.forEach(template => {
        html += `
            <div class="email-template-card" onclick="openEmailComposer('${template.id}')">
                <div class="template-number">${template.number}</div>
                <h4 class="template-title">${template.title}</h4>
                <div class="template-recipient">${template.recipientType}</div>
                <div class="template-subject">${template.subject}</div>
                <button class="btn-use-template">Use Template</button>
            </div>
        `;
    });
    html += '</div>';
    
    container.innerHTML = html;
}

// Open email composer with template
function openEmailComposer(templateId) {
    const template = emailTemplatesCache.find(t => t.id === templateId);
    if (!template) {
        alert('Template not found');
        return;
    }
    
    // Create modal HTML
    let fieldsHTML = '';
    template.requiredFields.forEach(field => {
        // Replace underscores with spaces for display
        const displayName = field.replace(/_/g, ' ');
        fieldsHTML += `
            <div class="form-group">
                <label for="field-${field}">${displayName}:</label>
                <input type="text" id="field-${field}" name="${field}" class="form-control" placeholder="Enter ${displayName}">
            </div>
        `;
    });
    
    const modalHTML = `
        <div class="email-composer-overlay" onclick="closeEmailComposer()">
            <div class="email-composer-modal" onclick="event.stopPropagation()">
                <div class="composer-header">
                    <h2>Compose: ${template.title}</h2>
                    <button class="close-modal-btn" onclick="closeEmailComposer()">×</button>
                </div>
                <div class="composer-body">
                    <div class="template-info">
                        <strong>To:</strong> ${template.recipientType}<br>
                        <strong>Template #${template.number}</strong>
                    </div>
                    <form id="email-composer-form">
                        <h4>Fill in Required Fields:</h4>
                        ${fieldsHTML}
                        <div class="form-group">
                            <label>Preview Subject:</label>
                            <div class="preview-box" id="subject-preview">${template.subject}</div>
                        </div>
                        <div class="form-group">
                            <label>Preview Body:</label>
                            <div class="preview-box preview-body" id="body-preview">${template.body}</div>
                        </div>
                    </form>
                </div>
                <div class="composer-footer">
                    <button class="btn btn-secondary" onclick="closeEmailComposer()">Cancel</button>
                    <button class="btn btn-primary" onclick="sendApprovedEmail('${template.id}')">Send Email</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Add input listeners to update preview
    template.requiredFields.forEach(field => {
        const input = document.getElementById(`field-${field}`);
        if (input) {
            input.addEventListener('input', () => updateEmailPreview(template));
        }
    });
}

// Update email preview as user types
function updateEmailPreview(template) {
    let subject = template.subject;
    let body = template.body;
    
    template.requiredFields.forEach(field => {
        const input = document.getElementById(`field-${field}`);
        if (input && input.value) {
            const regex = new RegExp(`\\{${field}\\}`, 'g');
            subject = subject.replace(regex, input.value);
            body = body.replace(regex, input.value);
        }
    });
    
    document.getElementById('subject-preview').textContent = subject;
    document.getElementById('body-preview').textContent = body;
}

// Send approved email
function sendApprovedEmail(templateId) {
    const template = emailTemplatesCache.find(t => t.id === templateId);
    if (!template) return;
    
    // Collect field values
    const fieldValues = {};
    let allFieldsFilled = true;
    
    template.requiredFields.forEach(field => {
        const input = document.getElementById(`field-${field}`);
        if (input) {
            fieldValues[field] = input.value;
            if (!input.value.trim()) {
                allFieldsFilled = false;
            }
        }
    });
    
    if (!allFieldsFilled) {
        alert('Please fill in all required fields before sending.');
        return;
    }
    
    // Replace placeholders in subject and body
    let subject = template.subject;
    let body = template.body;
    
    template.requiredFields.forEach(field => {
        const regex = new RegExp(`\\{${field}\\}`, 'g');
        subject = subject.replace(regex, fieldValues[field]);
        body = body.replace(regex, fieldValues[field]);
    });
    
    // Extract recipient name (try to get from field values)
    const recipientName = fieldValues['Buyer_Name'] || fieldValues['Seller_Name'] || 
                          fieldValues['Client_Name'] || fieldValues['Admin_Name'] || 
                          template.recipientType;
    
    // Send to API
    fetch('/api/send-approved-email', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            templateId: template.id,
            recipientName: recipientName,
            subject: subject,
            body: body,
            fieldValues: fieldValues
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Email sent successfully!');
            closeEmailComposer();
            // Reload messages to show the sent email
            loadMessages();
        } else {
            alert('Failed to send email: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error sending email:', error);
        alert('Failed to send email. Please try again.');
    });
}

// Close email composer
function closeEmailComposer() {
    const modal = document.querySelector('.email-composer-overlay');
    if (modal) {
        modal.remove();
    }
}
</script>

<%- include('partials/footer') %> 